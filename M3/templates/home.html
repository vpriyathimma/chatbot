<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>chatbot</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"> -->
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Allerta+Stencil&display=swap");

      body {
        margin: 0%;
        padding: 0%;
        background-image: url("/static/images/bg7.jpg");
        background-size: cover; /* Cover the whole screen */
        background-repeat: no-repeat; /* Prevent repeating the image */
        background-position: center;
      }

      .all-show {
        padding: 20px;
        background-image: url("/static/images/nav1.jpg");
        background-size: cover; /* Cover the whole screen */
        background-repeat: no-repeat; /* Prevent repeating the image */
        background-position: center; /* Center the image */
      }

      .nav-link {
        color: #fff !important;
      }

      .navbar-brand {
        color: #fff;
        font-family: "Allerta Stencil", sans-serif;
        margin-bottom: 4px;
        font-size: 27px;
        text-decoration: none;
      }

      .navbar-brand:hover {
        color: #fff;
      }
      .nav-link {
        font-weight: 800;
      }
      .nav-link:hover {
        font-weight: 200;
      }

      .navbar-red {
        /* background-color: rgb(112, 0, 134); */
        color: #fff;
      }

      .user_icon {
        color: #ffd901fc;
      }
      .all-show {
        z-index: 10;
      }
      .chat-history h2 {
        color: white;
      }
      .my_answer_text {
        background-colour: red;
        margin: 0;
        padding: 0;
      }
      .my_answer_text p {
        padding: 0;
        padding-left: 14px;
        margin: 5px;
      }
      .my_answer_text h2 {
        padding: 0;
        padding-top: 5px;
        padding-bottom: 5px;
        margin: 2px;
      }
      .bot_respo {
        text-decoration: underline;
        padding-bottom: 5px;
      }
      .bot_Qsn {
        text-decoration: underline;
        font-size: 10px;
      }
      .microphone {
        font-size: 25px;
        color: white;
        padding: 5px;
        padding-left: 10px;
        cursor: pointer;
      }
      .microphone:hover {
        font-size: 30px;
      }
    </style>
  </head>
  <body>
    <!-- nav bar section start -->

    <nav
      class="navbar navbar-expand-lg navbar-red navbar-dark"
      style="min-height: 50px"
    >
      <div
        class="container-fluid all-show"
        style="
          display: flex;
          justify-content: space-between;
          padding-left: 30px;
          padding-right: 30px;
        "
      >
        <div>
          <a class="navbar-brand" href="#" style="padding-top: 15px"
            >Chat Bot
          </a>
        </div>

        <div>
          <div
            class="collapse navbar-collapse"
            id="navbarSupportedContent"
            style="display: inline"
          >
            <i class="fa fa-user user_icon" style="font-size: 24px"></i>
            <a class="nav-link user_name" style="text-decoration: none" href="#"
              >{{username}}</a
            >
            <a href="/logout" style="padding: 15px" class="nav-link">LogOut</a>

            <!-- <ul class="navbar-nav mr-auto mb-2 mb-lg-0" style="display: flex;">
              
              <li class="nav-item">
                <a class="nav-link" href="#">Services</a>
              </li>

            </ul> -->
          </div>
        </div>
      </div>
    </nav>

    <!-- nav bar end  -->

    <!-- chat section -->
    <div class="chat-section" id="chatSection">
      <div class="chat-history">
        <h2>Chat History</h2>
        <li class="message" id="new_window">New Chat</li>
        {% for i in date_t%}
        <li class="message my-button history" data-date="{{ i }}">{{i}}</li>
        {% endfor %}

        <ul id="historyList"></ul>
      </div>
      <div class="chat-container">
        <div class="chat-box">
          <div class="messages" id="messages"></div>
        </div>
        <div class="chat-input">
          <input
            type="text"
            id="chatInput"
            placeholder="Type a message..."
            required
          />
          <!-- <i class="fa fa-microphone microphone" id="recordButton" ></i> -->
          <button id="sendMessage">Send</button>
        </div>
      </div>
    </div>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;

      const recordButton = document.getElementById("recordButton");
      const downloadLink = document.getElementById("downloadLink");

      // Event listener for the record button
      recordButton.addEventListener("click", () => {
        if (!isRecording) {
          startRecording();
        } else {
          stopRecording();
        }
      });

      // Start recording function
      function startRecording() {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            // Update button to show stop icon
            recordButton.style.color = "Red";
            isRecording = true;

            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
              sendAudioToServer(audioBlob);
              // const audioUrl = URL.createObjectURL(audioBlob);
              // downloadLink.href = audioUrl;

              // downloadLink.download = 'recording.wav';
              // downloadLink.style.display = 'block';
              // downloadLink.innerHTML = "Download Audio";
              /////////////////////////////////
              fetch("/audio", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  question: message,
                }),
              })
                .then((response) => response.json())
                .then((data) => {
                  console.log(data.message);
                  addMessage(convertTextToHTML(data.answer), "bot");
                  chatInput.value = "";

                  // Handle response data
                  if (data.status === "success") {
                    // Display
                    alert(" successful!");
                  } else {
                    document.getElementById("error").innerHTML = `Error`;
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                });
              /////////////////////////////////
              audioChunks = []; // Reset for the next recording
            };
          })
          .catch((error) =>
            console.error("Error accessing microphone:", error)
          );
      }

      function sendAudioToServer(audioBlob) {
        const formData = new FormData();
        formData.append("audio", audioBlob, "audio.wav");

        fetch("/upload_audio", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Display
              document.getElementById("chatInput").value = data.text;
            } else {
              const prev = document.getElementById("chatInput").value;
              document.getElementById("chatInput").value = prev + " ";
            }
          })
          .catch((error) => {
            document.getElementById("chatInput").value = "";
          });
      }

      //   function toggleButtonStyle() {
      //     if (isRecording ==true) { // Run for 10 seconds
      //         if (isDefaultStyle) {
      //           recordButton.style.color ="30px";
      //         } else{

      //         }
      //         // isDefaultStyle = !isDefaultStyle;
      //         // duration += 1; // Increment duration counter
      //         setTimeout(toggleButtonStyle, 700); // Change style every second
      //     }
      // }

      // toggleButtonStyle();

      // Stop recording function
      function stopRecording() {
        mediaRecorder.stop();

        // Update button to show mic symbol again
        recordButton.style.color = "white";
        // recordButton.style.color ="25px";
        // recordButton.innerHTML = "";
        isRecording = false;
        audioChunks = [];
      }
    </script>

    <script>
      // Add event listener for the input field
      document
        .getElementById("chatInput")
        .addEventListener("keydown", function (event) {
          // Check if the pressed key is Enter (key code 13 or event.key === "Enter")
          if (event.key === "Enter") {
            // Prevent default form submission behavior (if inside a form)
            event.preventDefault();

            // Call the desired function
            sendMessageButton.click();
          }
        });

      function convertTextToHTML(text) {
        // Split the text into lines
        const lines = text.split("\n");
        let htmlOutput = "";

        // Loop through each line and format accordingly
        lines.forEach((line) => {
          line = line.trim(); // Remove any extra spaces

          if (line.startsWith("#")) {
            // Convert lines starting with '#' to headings (<h1> or <h2> depending on the number of #)
            const headingLevel = line.match(/^#+/)[0].length; // Determine heading level (number of #)
            const headingText = line.replace(/^#+/, "").trim(); // Remove '#' and trim the rest
            htmlOutput += `<h2>${headingText}</h2>`;
          } else if (line.startsWith("**") && line.endsWith("**:")) {
            // Convert lines surrounded by '**' to bold subheadings (<strong>)
            const subheadingText = line.replace(/\*\*/g, "").trim(); // Remove '**' from both sides
            htmlOutput += `<strong>${subheadingText}</strong>`;
          } else if (line.startsWith("*   **")) {
            const splt = line.split(":");
            splt.forEach((ln) => {
              if (ln.startsWith("*   **") && ln.endsWith("**")) {
                const lntext = ln.replace(/\*\*/g, "").trim(); // Remove '**' from both sides
                const ltext = lntext.replace(/\*/g, "").trim(); // Remove '**' from both sides

                htmlOutput += `<strong>${ltext} :</strong>`;
              } else {
                const tt = ln.replace(/\*\*/g, "").trim(); // Remove '**' from both sides
                const ttx = tt.replace(/\*\ \ \*\*/g, "").trim(); // Remove '**' from both sides
                htmlOutput += `<p>${ttx}</p>`;
              }
            });
            // Convert lines surrounded by '**' to bold subheadings (<strong>)
            // const subheadingText = line.replace(/\*\*/g, '').trim(); // Remove '**' from both sides
            // htmlOutput += `<strong>${subheadingText}</strong>`;
          } else if (line === "") {
            // Add an empty paragraph or line break for empty lines
            htmlOutput += ``;
          } else {
            const textText = line.replace(/\*\*/g, "").trim(); // Remove '**' from both sides
            const ttext = textText.replace(/\*/g, "").trim();
            // All other lines are normal paragraphs (<p>)
            htmlOutput += `<p>${ttext}</p>\n`;
          }
        });

        return htmlOutput;
      }
    </script>

    <script>
      // Elements
      const chatSection = document.getElementById("chatSection");
      const sendMessageButton = document.getElementById("sendMessage");
      const chatInput = document.getElementById("chatInput");
      const messagesContainer = document.getElementById("messages");
      const historyList = document.getElementById("historyList");
      const username = document.getElementById("username");
      const history = document.getElementsByClassName("message");

      // Send Message
      sendMessageButton.addEventListener("click", () => {
        const message = chatInput.value.trim();
        console.log(username);
        if (message) {
          addMessage(message, "user");
          fetch("/add_question", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              question: message,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log(data.message);
              addMessage(convertTextToHTML(data.answer), "bot");
              chatInput.value = "";

              // Handle response data
              if (data.status === "success") {
                // Display
                alert(" successful!");
              } else {
                document.getElementById("error").innerHTML = `Error`;
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });

          // Simulate bot response
          // setTimeout(() => {
          //     addMessage('This is a bot response.This is a bot response. This is a bot response. This is a bot response.This is a bot response.This is a bot response.This is a bot response.This is a bot response.This is a bot response.This is a bot response.This is a bot response.This is a bot response.', 'bot');
          // }, 1000);
        }
      });

      // Add Message to Chat
      function addMessage(text, type) {
        const messageElement = document.createElement("div");
        messageElement.className = "message " + type + "-message";
        if (type == "bot") {
          messageElement.innerHTML =
            "<div class='my_answer_text'> " + text + "</div>";
        } else {
          messageElement.innerHTML = text;
        }
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Add to history
        // const historyItem = document.createElement('li');
        // historyItem.textContent = text;
        // historyItem.className = type + '-message';
        // historyList.appendChild(historyItem);
      }
      sendMessageButton.addEventListener("click", () => {
        this;
      });

      // Select all buttons with the class 'my-button'
      const buttons = document.querySelectorAll(".my-button");

      // Function to handle the button click
      function handleButtonClick(event) {
        // Get the class name of the clicked button
        const date = event.target.getAttribute("data-date");
        console.log("Clicked button class name:", event.target.className);
        console.log("Clicked button  date:", date);
        // const messages_element = document.getElementsByClassName('messages');
        messagesContainer.innerHTML = "";

        fetch("/show_history", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            date: date,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Handle response data
            if (data.status === "success") {
              // Display
              const qun = data.question;
              const ansr = data.answer;
              console.log(qun.length);
              console.log(ansr.length);
              for (let i = 0; i < qun.length; i++) {
                addMessage(qun[i], "user");
                addMessage(convertTextToHTML(ansr[i]), "bot");
              }
            } else {
              document.getElementById("error").innerHTML = `Error`;
            }
          });
      }
      // Add event listeners to each button
      buttons.forEach((button) => {
        button.addEventListener("click", handleButtonClick);
      });
      const new_chat = document.getElementById("new_window");
      new_chat.addEventListener("click", () => {
        messagesContainer.innerHTML = "";
      });
    </script>

    <style>
      .chat-section {
        display: flex;
        width: 100%;
        max-width: 1200px;
        height: 570px;
      }
      .chat-history {
        width: 200px;
        max-height: 100vh;
        background: #ffffff00;
        border-right: 1px solid #ccc;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        background-image: url("/static/images/history1.jpg");
        background-size: cover; /* Cover the whole screen */
        background-repeat: no-repeat; /* Prevent repeating the image */
        background-position: center;
      }
      .chat-history h2 {
        margin-top: 0;
      }
      .chat-history li {
        padding-left: 3px;
        margin-left: 30px;
        color: #f1f1f1;
        font-weight: 700;
        cursor: pointer;
      }
      .chat-history li:hover {
        color: #29bfff;
        text-decoration: underline;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin: 0px;
        /* border-left:7px solid rgba(0, 65, 89, 0.344);
            border-right:0px solid rgba(0, 65, 89, 0.342); */
      }
      .chat-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0px;
        border-radius: 10px;
        border-bottom: 1px solid #cccccc;
        overflow-y: auto;
        background-color: #ffffff9f;
        margin: 10px;
      }
      .messages {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow-y: auto;
        padding: 10px;
      }

      .message {
        padding: 10px;
        border-radius: 5px;
      }
      .user-message {
        background-color: #e1ffc7;
        align-self: flex-end;
        text-align: end;
      }
      .bot-message {
        background-color: rgba(255, 255, 255, 0.524);
        align-self: flex-start;
        border: #001435;
      }
      .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
        background-color: #001435;
      }
      .chat-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .chat-input button {
        padding: 10px 20px;
        border: none;
        background-color: #1da1f2;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
      }
      .chat-input button:hover {
        background-color: #0d8bf2;
      }
      .input-data {
        position: relative;
        margin-bottom: 15px;
      }
      .input-data input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
      }
      .input-data label {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 14px;
        color: #aaa;
        transition: 0.3s;
      }
      .input-data input:focus + label,
      .input-data input:not(:placeholder-shown) + label {
        top: -10px;
        left: 10px;
        font-size: 12px;
        color: #1da1f2;
      }
      .submit-btn .input-data {
        overflow: hidden;
        height: 45px !important;
        width: 25% !important;
      }
      .submit-btn .input-data .inner {
        height: 100%;
        width: 300%;
        position: absolute;
        left: -100%;
        background: -webkit-linear-gradient(
          right,
          #56d8e4,
          #9f01ea,
          #56d8e4,
          #9f01ea
        );
        transition: all 0.4s;
      }
      .submit-btn .input-data:hover .inner {
        left: 0;
      }
      .submit-btn .input-data input {
        background: none;
        border: none;
        color: #fff;
        font-size: 17px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        position: relative;
        z-index: 2;
      }
      .underline {
        border-bottom: 2px solid #1da1f2;
        margin-top: 5px;
        height: 2px;
      }
      #error {
        margin-top: 5px;
        color: red;
      }
    </style>
  </body>
</html>
